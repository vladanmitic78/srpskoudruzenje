version: '3.8'

# ===========================================
# SKUD Täby - TEST/STAGING Environment
# No SSL, for testing before production
# ===========================================

services:
  mongodb:
    image: mongo:6
    container_name: skud_mongodb_test
    restart: always
    ports:
      - "27017:27017"  # Exposed for database restore
    volumes:
      - mongodb_data_test:/data/db
      - ./backups:/backups  # For backup/restore operations
    networks:
      - skud_network_test
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: skud_backend_test
    restart: always
    environment:
      - MONGO_URL=mongodb://mongodb:27017
      - DB_NAME=skud_taby
      - FRONTEND_URL=${FRONTEND_URL:-http://89.167.2.215}
      - SMTP_HOST=mailcluster.loopia.se
      - SMTP_PORT=465
      - SMTP_USER=info@srpskoudruzenjetaby.se
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=info@srpskoudruzenjetaby.se
      - SMTP_FROM_NAME=SKUD Täby (TEST)
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-test-secret-change-in-production}
    volumes:
      - uploads_data_test:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - skud_network_test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.test
      args:
        - REACT_APP_BACKEND_URL=${FRONTEND_URL:-http://89.167.2.215}
    container_name: skud_frontend_test
    restart: always
    depends_on:
      - backend
    networks:
      - skud_network_test
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    container_name: skud_nginx_test
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx.test.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    networks:
      - skud_network_test
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  skud_network_test:
    driver: bridge

volumes:
  mongodb_data_test:
    driver: local
  uploads_data_test:
    driver: local
